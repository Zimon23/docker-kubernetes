# VMware에서 Ubuntu 클라우드 이미지 사용 절차
1. Ubuntu 클라우드 이미지 다운로드 → VMDK 변환
2. VM별 변수 정의 (vars/hosts.yaml)
3. cloud-init 템플릿
4. seed ISO 일괄 생성
5. VMware에 연결/부팅

## 사전 준비 (WSL 설치)
windows 10, 11에서 작업을 진행 하려면 wsl를 설치 하고 wsl 우분투에서 진행을 합니다 

관리자 권한 PowerShell을 열고 아래 한 줄:
```
wsl --install
```

필요한 기능(WSL + VM Platform)을 켜고, 최신 WSL과 기본 리눅스 배포판(보통 Ubuntu)을 설치합니다.

설치가 끝나면 재부팅 → 첫 실행 시 리눅스 사용자명/비밀번호를 설정하면 완료!

원하는 배포판을 지정하려면:(PowerShell 작업)
```
wsl --list --online          #설치 가능한 배포판 목록 보기
wsl --install -d Ubuntu-22.04
```

업데이트/버전 확인:(PowerShell 작업)
```
wsl --update                 # WSL 커널/엔진 업데이트
wsl --status                 # 현재 상태/버전 확인
wsl -l -v                    # 설치된 배포판과 WSL 버전(1/2) 확인
```

자주 쓰는 관리 명령(PowerShell 작업)
```
wsl -l -v                        # 배포판/버전 목록
wsl --set-version Ubuntu 2       # 특정 배포판을 WSL2로 변환
wsl -d Ubuntu                    # Ubuntu 실행
wsl -t Ubuntu                    # Ubuntu 종료
wsl --shutdown                   # 모든 WSL 종료
wsl --unregister Ubuntu          # Ubuntu 삭제(데이터도 삭제)
```

시스템 요구/체크

UEFI에서 가상화(VT-x/AMD-V) 가 켜져 있어야 합니다.

작업 관리자 → 성능 탭에 CUP 가상화 옵션이 가상화: 사용” 라고 보이면 OK.

옵션 설정(성능/시스템d 등)
1) 성능 튜닝: ~/.wslconfig (Windows 사용자 폴더)
C:\Users\<사용자>\.wslconfig
```
[wsl2]
memory=6GB          # WSL 메모리 상한
processors=4        # CPU 코어 수
swap=2GB            # 스왑 파일 크기
localhostForwarding=true
```

변경 후:(PowerShell 작업)
```
wsl --shutdown
```

다시 실행하면 적용됩니다.

2) systemd 활성화(서비스/도커 등 필요 시) (ubuntu에서  작업)

리눅스 측 /etc/wsl.conf:
```
sudo vi /etc/wsl.conf
[boot]
systemd=true
```

적용: (PowerShell 작업)
```
wsl --shutdown
```

다시 실행 후 systemctl status로 확인.

작업 폴더 구조 

vm-fleet/
├─ base/
│  ├─ ubuntu2204-cloud.vmdk        # 변환된 클라우드 이미지 디스크(생성할 예정임)
├─ cloudinit/
│  ├─ templates/
│  │  ├─ user-data.tpl
│  │  ├─ meta-data.tpl
│  │  └─ network-config-dhcp.tpl
│  │     network-config-static.tpl
│  └─ out/                         # VM별 seed ISO 생성물
├─ vars/
│  └─ hosts.yaml                   # VM별 변수(이름, IP, GW, 키 등)
├─ scripts/
│  └─ make_seed_isos.sh            # Linux/WSL용 일괄 생성 스크립트
└─ ansible/
   ├─ inventory.ini
   └─ site.yml                     # 공통 초기세팅 플레이북

폴더 생생 
```
mkdir vm-fleet
mkdir cloudinit
mkdir cloudinit\templates
mkdir cloudinit\out
mkdir vars
mkdir scripts
mkdir ansible
```

vi 편집기 설치 
```
sudo apt update
audo apt install -y vim
```

## 1. Ubuntu 클라우드 이미지 다운로드 → VMDK 변환
Canonical에서 공식 제공하는 이미지를 받습니다.

```
sudo apt update && sudo apt install -y qemu-utils cloud-image-utils
wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
qemu-img convert -f qcow2 -O vmdk jammy-server-cloudimg-amd64.img ubuntu2204-cloud.vmdk
mv ubuntu2204-cloud.vmdk vm-fleet/base/
rm jammy-server-cloudimg-amd64.img 
```

## 2. VM별 변수 정의 (vars/hosts.yaml)
```
vi vars/hosts.yaml

vms:
  - name: k8s-master
    hostname: k8s-master
    dhcp: true               # ← DHCP 사용
    ssh_authorized_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... your_key ..."
    user: "kosa"

  - name: k8s-node1
    hostname: k8s-node1
    dhcp: true               # ← DHCP 사용
    ssh_authorized_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... your_key ..."
    user: "kosa"

  - name: k8s-node2
    hostname: k8s-node2
    dhcp: true               # ← DHCP 사용
    ssh_authorized_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... your_key ..."
    user: "kosa"

```
## 3. cloud-init 템플릿
사용자 정보 파일 
vi cloudinit/templates/user-data.tpl
```
#cloud-config
preserve_hostname: false
hostname: ${HOSTNAME}
manage_etc_hosts: true

users:
  - name: ${USER}
    ssh_authorized_keys:
      - ${SSH_KEY}
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash

package_update: true
package_upgrade: true

runcmd:
  - timedatectl set-timezone Asia/Seoul
  - systemctl enable --now qemu-guest-agent || true
  - echo "OK: cloud-init finished on $(date)" > /var/log/cloudinit_done

```
host 정보 파일 
vi cloudinit/templates/meta-data.tpl
```
instance-id: iid-${HOSTNAME}
local-hostname: ${HOSTNAME}
```

고정ip 정보 파일 
vi cloudinit/templates/network-config-static.tpl
```
version: 2
ethernets:
  ens33:
    dhcp4: false
    addresses: [${IP}/${PREFIX}]
    gateway4: ${GATEWAY}
    nameservers:
      addresses: [${DNS}]
```

동적ip 정보 파일 
vi cloudinit/templates/network-config-dhcp.tpl
```
version: 2
ethernets:
  ens33:
    dhcp4: true
```
## 4. seed ISO 일괄 생성
vi scripts/make_seed_isos.sh
```
#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VAR_FILE="$ROOT_DIR/vars/hosts.yaml"
OUT_DIR="$ROOT_DIR/cloudinit/out"
TPL_DIR="$ROOT_DIR/cloudinit/templates"

mkdir -p "$OUT_DIR"

# yq 필요: sudo snap install yq 또는 apt install yq (버전에 따라)
command -v yq >/dev/null || { echo "yq가 필요합니다."; exit 1; }

COUNT=$(yq '.vms | length' "$VAR_FILE")

for ((i=0; i<COUNT; i++)); do
  NAME=$(yq ".vms[$i].name" "$VAR_FILE")
  HOSTNAME=$(yq ".vms[$i].hostname" "$VAR_FILE")
  USER=$(yq ".vms[$i].user" "$VAR_FILE")
  SSH_KEY=$(yq ".vms[$i].ssh_authorized_key" "$VAR_FILE")
  DHCP=$(yq ".vms[$i].dhcp // false" "$VAR_FILE")

  USER_DATA="$OUT_DIR/${NAME}-user-data"
  META_DATA="$OUT_DIR/${NAME}-meta-data"
  NETCFG="$OUT_DIR/${NAME}-network-config"
  ISO="$OUT_DIR/${NAME}-seed.iso"

  # user-data/meta-data 렌더링(간단히 envsubst 대체)
  sed -e "s|\${HOSTNAME}|$HOSTNAME|g" \
      -e "s|\${USER}|$USER|g" \
      -e "s|\${SSH_KEY}|$SSH_KEY|g" \
      "$TPL_DIR/user-data.tpl" > "$USER_DATA"

  sed -e "s|\${HOSTNAME}|$HOSTNAME|g" \
      "$TPL_DIR/meta-data.tpl" > "$META_DATA"

  if [ "$DHCP" = "true" ]; then
    cp "$TPL_DIR/network-config-dhcp.tpl" "$NETCFG"
  else
    IP=$(yq ".vms[$i].ip" "$VAR_FILE")
    PREFIX=$(yq ".vms[$i].prefix" "$VAR_FILE")
    GATEWAY=$(yq ".vms[$i].gateway" "$VAR_FILE")
    DNS=$(yq ".vms[$i].dns | join(\", \")" "$VAR_FILE")
    sed -e "s|\${IP}|$IP|g" \
        -e "s|\${PREFIX}|$PREFIX|g" \
        -e "s|\${GATEWAY}|$GATEWAY|g" \
        -e "s|\${DNS}|$DNS|g" \
        "$TPL_DIR/network-config-static.tpl" > "$NETCFG"
  fi

  # seed.iso 생성
  cloud-localds --network-config="$NETCFG" "$ISO" "$USER_DATA" "$META_DATA"
  echo "Made: $ISO"
done

```

### 필수 패키지 설치

cloud-localds와 yq v4가 필요합니다.

```
sudo apt update
sudo apt install -y cloud-image-utils yq jq
```

설치 후 버전 확인:
```
yq --version

#다음과 같이 출력됨 
yq (https://github.com/mikefarah/yq/) version v4.46.1

```

실행 권한 부여
```
chmod +x scripts/make_seed_isos.sh
```

4) 스크립트 실행

```
./scripts/make_seed_isos.sh
```

정상이라면 cloudinit/out/ 안에 VM별 *-seed.iso가 생성됩니다.

ls -l cloudinit/out/*.iso

5) VMware에 ISO 연결

WSL에서 현재 폴더를 탐색기로 열기:
```
explorer.exe .
```

6) host 별 가상머신 폴더 생성 
 ─k8s
    ├─master
    ├─node1
    └─node2

7) VM base 이미지 파일을 host 별 가상머신 폴더로 복사 
vm-fleet/base/ubuntu2204-cloud.vmdk  -> master
vm-fleet/base/ubuntu2204-cloud.vmdk  -> node1
vm-fleet/base/ubuntu2204-cloud.vmdk  -> node2

8) VM Seed 별 이미지 파일을 host 별 가상머신 폴더로 복사 
cloudinit/out/k8s-master-seed.iso  -> master
cloudinit/out/k8s-node1-seed.iso  -> node1
cloudinit/out/k8s-node2-seed.iso  -> node2

## 5. VMware에 연결/부팅

주의 : Workstation Player는 “기존 디스크 사용(Use existing disk)” 옵션이 마법사에 직접 나오지 않습니다. 새 VM을 일단 만든 다음, 디스크를 교체하는 방식으로 진행합니다.

1) 새 VM 틀 만들기 (OS 설치는 하지 않음)

    1. VMware Workstation 17 Player 실행
    2. Create a New Virtual Machine 클릭
    3. “I will install the operating system later” 선택 → Next (설치 ISO를 사용하지 않습니다)
    4. Guest OS:
        Linux / Version: Ubuntu 64-bit 선택 → Next
    5. VM 이름과 저장 위치 지정
       (master 예 : dev/master/ubuntu2204-cloud.vmdk) → Next
    6. 디스크 설정 화면에서 임시로 용량 지정(예: 20GB)하고 “Store virtual disk as a single file” 선택 → Next → Finish
    
    여기서 만든 디스크는 잠깐만 쓰는 자리표시자입니다. 다음 단계에서 삭제하고 VMDK로 바꿉니다.

2) 기존 VMDK로 디스크 교체

    1. 방금 만든 VM을 선택 → Edit virtual machine settings
    2. Hardware 탭에서 Hard Disk (SCSI) 선택 → Remove (삭제)
    3. Add… → Hard Disk → Next
    4. SCSI(권장) 선택 → Next
    5. “Use an existing virtual disk” 선택 → Next
    6. Browse… → ubuntu2204-cloud.vmdk 선택 → Finish
        “이 디스크를 최신 형식으로 변환할까요?”가 뜨면
        Keep Existing Format(유지) 또는 Convert(변환) 중 둘 다 사용 가능합니다.
        변환하면 스냅샷 호환성이 좋아지나, 원본을 건드리기 싫다면 Keep 권장.

3) cloud-init seed ISO 연결
    1. CD/DVD (SATA) 항목 선택
    2. Use ISO image file 선택 → Browse… → 해당 VM용 seed.iso 지정
    3. Connect at power on 체크
    4. Network Adapter 설정:
        NAT: 호스트 공유 인터넷만 필요할 때
    5. Memory/Processors: (예: 메모리 2~4GB, vCPU 2개 정도) 필요에 맞게 조정(2G선택)

일부 클라우드 이미지는 UEFI가 더 잘 맞는 경우가 있습니다. (Secure Boot는 비활성 권장)

4) Hard Disk 용량 변경 
    1. Hard Disk를 선택 → Expand disk capacity → Expand... 선택 → 40G 변경  
5) 첫 부팅

    1. Play virtual machine 클릭
    2. “Did you move or copy this VM?” 팝업이 뜨면 I copied it 선택

        → 새 MAC 주소가 생성되어 DHCP에서 새 IP를 받습니다.

    3. 부팅이 완료되면 cloud-init이 seed ISO의 설정(hostname, 사용자, SSH키, 네트워크)을 적용합니다.

    적용 로그: /var/log/cloud-init-output.log, /var/log/cloud-init.log

6) 접속/확인(동적 IP 사용시)

    NAT(VMnet8)

    Windows 호스트가 DHCP 서버 역할을 합니다.
    IP 주소 발급 이력을 관리하는 파일입니다 C:\ProgramData\VMware\vmnetdhcp.leases

    이 파일을 열어 VM의 **MAC 주소**에 해당하는 lease 항목의 IP를 찾으세요. 

    PowerShell
    
    ``` 
    notepad "C:\ProgramData\VMware\vmnetdhcp.leases"
    
    ```

SSH 접속: ssh <user>@<VM_IP>

