### 동적 프로비저닝(Dynamic Provisioning)

동적 프로비저닝(Dynamic Provisioning)은 Kubernetes에서 스토리지를 관리하는 가장 현대적이고 효율적인 방법입니다. 이전 예제들에서 PV를 수동으로 생성(정적 프로비저닝)했지만, 동적 프로비저닝은 이러한 수동 작업을 자동화합니다.

동적 프로비저닝이란?

* 개념: 사용자가 PersistentVolumeClaim (PVC)을 생성할 때, Kubernetes가 해당 PVC의 요청(용량, 접근 모드, 스토리지 클래스 등)에 맞춰 새로운 `PersistentVolume (PV)`을 자동으로 생성하고 PVC에 바인딩하는 방식입니다.
    * 필요성:
        * 자동화: 클러스터 관리자가 PV를 미리 생성해 둘 필요가 없습니다. 사용자가 PVC를 요청하면  자동으로 PV가 생성됩니다.
        * 유연성: 다양한 스토리지 유형(SSD, HDD, 고성능, 저비용 등)을 StorageClass로 정의해두고, 사용자는 필요한 StorageClass만 지정하면 됩니다.
        * 효율성: 사용하지 않는 PV가 클러스터에 남아있지 않아 스토리지 자원 낭비를 줄일 수 있습니다.
   * 핵심 구성 요소:
        1. `StorageClass`: PV를 동적으로 프로비저닝하기 위한 "설계도" 또는 "템플릿"입니다. 어떤 프로비저너를 사용할지, 어떤 파라미터로 PV를 생성할지 등을 정의합니다.
        2. 프로비저너 (Provisioner): StorageClass에 정의된 실제 스토리지 생성 로직을 담당하는 컨트롤러입니다. 클라우드 제공업체(AWS EBS, GCE PD 등)의 API를 호출하거나, NFS 서버에 디렉터리를 생성하는 등의 작업을 수행합니다.

예제: local-path-provisioner를 이용한 동적 프로비저닝

  클라우드 환경이 아닌 일반적인 Kubernetes 클러스터에서 동적 프로비저닝을 시연하기 위해 local-path-provisioner를 사용하겠습니다. 이 프로비저너는 각 노드의 로컬 파일 시스템에 디렉터리를 생성하여 PV를 시뮬레이션합니다.

  주의: local-path-provisioner는 프로덕션 환경의 데이터베이스나 중요한 애플리케이션에는 적합하지
  않습니다. 노드 장애 시 데이터가 유실될 수 있습니다. 테스트 목적으로만 사용하세요.

  ---

  사전 준비: local-path-provisioner 설치

  local-path-provisioner는 클러스터에 한 번만 설치하면 됩니다.
```
# local-path-provisioner의 공식 manifest를 적용합니다.
# 이 명령어를 실행하면 local-path-provisioner Deployment, ServiceAccount, ClusterRole 등이 생성됩니다.
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml

```
  설치 후, kubectl get pods -n local-path-storage 명령어로 프로비저너 파드가 Running 상태인지
  확인하세요.

```
kubectl get pods -n local-path-storage
```
  ---

  단계별 동적 프로비저닝 예제

폴더 구조 

dynamic1
├── dynamic-pod.yaml
├── dynamic-pvc.yaml
└── local-storage-class.yaml


  1. StorageClass 정의 (dynamic1/local-storage-class.yaml)

  local-path-provisioner를 사용하는 StorageClass를 정의합니다.

  dynamic1/local-storage-class.yaml 파일을 생성합니다.
```
#vi local-storage-class.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage-class
provisioner: rancher.io/local-path # local-path-provisioner의 프로비저너 이름
reclaimPolicy: Delete # PVC 삭제 시 PV와 실제 스토리지도 함께 삭제
volumeBindingMode: WaitForFirstConsumer # 파드가 스케줄링될 때까지 PV 바인딩을 지연

```
 * 설명:
       * name: local-storage-class: 이 StorageClass의 이름입니다.
       * provisioner: rancher.io/local-path: 이 StorageClass가 local-path-provisioner에 의해 관리됨을 나타냅니다.
       * reclaimPolicy: Delete: 이 StorageClass로 생성된 PV는 해당 PVC가 삭제될 때 함께 삭제됩니다.
       * volumeBindingMode: WaitForFirstConsumer: PVC가 생성되자마자 PV를 바인딩하지 않고, 해당 PVC를 사용하는 파드가 스케줄링될 때까지 기다립니다. 이는 hostPath와 같이 노드에 종속적인 스토리지에서 파드가 올바른 노드에 스케줄링된 후 PV가 생성되도록 하여 스케줄링 실패를 방지합니다.

  2. PVC 생성 (dynamic1/dynamic-pvc.yaml)

  위에서 정의한 local-storage-class를 사용하여 스토리지를 요청하는 PVC를 생성합니다.

  dynamic1/dynamic-pvc.yaml 파일을 생성합니다.
```
#vi dynamic-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-dynamic-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-storage-class # 위에서 정의한 StorageClass 이름 지정

```
* 설명: my-dynamic-pvc는 local-storage-class를 사용하여 1Gi의 ReadWriteOnce 스토리지를 요청합니다.

  3. Pod 생성 (dynamic1/dynamic-pod.yaml)

  my-dynamic-pvc를 사용하는 간단한 NGINX 파드를 생성합니다.

  dynamic1/dynamic-pod.yaml 파일을 생성합니다.
```
#vi dynamic-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: dynamic-nginx-pod
  labels:
    app: dynamic-nginx
spec:
  containers:
    - name: nginx
      image: nginx:latest
      ports:
        - containerPort: 80
      volumeMounts:
        - name: dynamic-storage
          mountPath: /usr/share/nginx/html
  volumes:
    - name: dynamic-storage
      persistentVolumeClaim:
        claimName: my-dynamic-pvc # 위에서 생성한 PVC 이름 지정

```

* 설명: dynamic-nginx-pod는 my-dynamic-pvc를 /usr/share/nginx/html에 마운트합니다.

  ---

  배포 및 확인

  1. 리소스 배포
```
# StorageClass 배포
kubectl apply -f local-storage-class.yaml

# PVC 배포 (이 시점에는 아직 PV가 생성되지 않습니다 - WaitForFirstConsumer)
kubectl apply -f dynamic-pvc.yaml

# Pod 배포 (Pod가 스케줄링될 때 PV가 동적으로 생성됩니다)
kubectl apply -f dynamic-pod.yaml
```
  2. 상태 확인
```
# StorageClass 확인
kubectl get sc

# PVC와 PV 상태 확인 (PV가 자동으로 생성되고 Bound 되는 것을 확인)
kubectl get pvc my-dynamic-pvc
kubectl get pv

# Pod 상태 확인
kubectl get pod dynamic-nginx-pod
```   
   * kubectl get pvc my-dynamic-pvc를 실행하면, my-dynamic-pvc가 Pending 상태였다가  dynamic-nginx-pod가 스케줄링되면서 자동으로 PV가 생성되고 Bound 상태로 바뀌는 것을 볼 수 있습니다.
   * kubectl get pv를 실행하면, pvc-로 시작하는 새로운 PV가 자동으로 생성되어 Bound 상태인 것을 확인할 수 있습니다. 이 PV는 local-path-provisioner에 의해 생성된 것입니다.

  3. 데이터 영속성 및 자동 삭제 확인

   1. 데이터 쓰기:
      파드에 접속하여 index.html 파일을 생성합니다.
```
kubectl exec -it dynamic-nginx-pod -- bash
echo "<h1>Hello from Dynamic Provisioning</h1>" > /usr/share/nginx/html/index.html
exit
```   
   2. 데이터 확인:
      파드의 IP 주소를 확인하고 curl로 접속하여 내용을 확인합니다.
```
kubectl get pod dynamic-nginx-pod -o wide
# 출력된 IP로 접속
curl <DYNAMIC_NGINX_POD_IP>
<h1>Hello from Dynamic Provisioning</h1>이 출력되어야 합니다.
```
   3. 파드 삭제 후 영속성 확인: 파드를 삭제해도 PV와 데이터는 유지됩니다.
```
kubectl delete pod dynamic-nginx-pod

# 잠시 후 다시 생성
kubectl apply -f dynamic-pod.yaml

# 새로운 파드 IP로 다시 접속하여 데이터 확인 데이터가 그대로 남아있는 것을 확인할 수 있습니다.
kubectl get pod dynamic-nginx-pod -o wide

# 출력된 IP로 접속
curl <DYNAMIC_NGINX_POD_IP>
<h1>Hello from Dynamic Provisioning</h1>이 출력되어야 합니다.

```
   4. PVC 삭제 시 PV 자동 삭제 확인:
      이제 PVC를 삭제하면, reclaimPolicy: Delete에 따라 PV도 자동으로 삭제됩니다.
```
kubectl delete pvc my-dynamic-pvc

# PV가 삭제되었는지 확인
kubectl get pv
```
pvc-로 시작하던 PV가 사라진 것을 확인할 수 있습니다.

이 예제를 통해 동적 프로비저닝이 어떻게 PV 생성을 자동화하고, 스토리지 관리를 간소화하는지 이해하셨기를 바랍니다.

